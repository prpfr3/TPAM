{% extends "../mainmenu/base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
{% endblock %}

{% block content %}

<div class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
    <div class="col-12 col-sm-10 col-md-6 col-lg-4">

        <div class="p-4 border rounded bg-light shadow-sm">

            <h2 class="text-center text-primary mb-4">Register an account</h2>

            <!-- Django messages -->
            {% if messages %}
                {% for message in messages %}
                    {% if message %}
                        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}">
                            {{ message }}
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}

            <form method="post" action="{% url 'users:register' %}" novalidate>
                {% csrf_token %}

                <!-- Username -->
                <div class="mb-3">
                    <label for="id_username" class="form-label">User name</label>
                    {{ form.username }}
                    {% for err in form.username.errors %}
                        <div class="text-danger small">{{ err }}</div>
                    {% endfor %}
                </div>

                <!-- Email -->
                <div class="mb-3">
                    <label for="id_email" class="form-label">Email address</label>
                    {{ form.email }}
                    {% for err in form.email.errors %}
                        <div class="text-danger small">{{ err }}</div>
                    {% endfor %}
                </div>

                <!-- Password 1 -->
                <div class="mb-3">
                    <label for="id_password1" class="form-label">Password</label>
                    <div class="input-group">
                        {{ form.password1 }}
                        <button class="btn btn-outline-secondary" type="button" id="togglePassword1">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    <div class="progress mt-2" style="height: 5px;">
                        <div id="pw-strength-bar" class="progress-bar"></div>
                    </div>
                    <div id="pw-hints" class="form-text mt-1"></div>
                    {% for err in form.password1.errors %}
                        <div class="text-danger small">{{ err }}</div>
                    {% endfor %}
                </div>

                <!-- Password 2 -->
                <div class="mb-3">
                    <label for="id_password2" class="form-label">Confirm password</label>
                    <div class="input-group">
                        {{ form.password2 }}
                        <button class="btn btn-outline-secondary" type="button" id="togglePassword2">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    {% for err in form.password2.errors %}
                        <div class="text-danger small">{{ err }}</div>
                    {% endfor %}
                </div>

                <!-- Non-field errors (e.g., passwords mismatch) -->
                {% for err in form.non_field_errors %}
                    <div class="text-danger small mb-2">{{ err }}</div>
                {% endfor %}

                <button type="submit" class="btn btn-primary w-100 mt-2">
                    Register
                </button>

                <input type="hidden" name="next" value="{% url 'locos:index' %}" />
            </form>

        </div>

    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {

    // --- Password strength ---
    const pw = document.getElementById('id_password1');
    const bar = document.getElementById('pw-strength-bar');
    const hints = document.getElementById('pw-hints');

    if (pw && bar) {
        bar.style.width = '0%';
        bar.style.transition = 'width 250ms ease';

        function passwordStrengthScore(value) {
            let score = 0;
            if (!value) return 0;
            if (value.length >= 8) score += 1;
            if (/[A-Z]/.test(value)) score += 1;
            if (/[0-9]/.test(value)) score += 1;
            if (/[^A-Za-z0-9]/.test(value)) score += 1;
            return score; // 0..4
        }

        function updateBar(value) {
            const score = passwordStrengthScore(value);
            const widths = ['0%','25%','50%','75%','100%'];
            const classes = ['bg-danger','bg-danger','bg-warning','bg-info','bg-success'];
            bar.className = 'progress-bar';
            bar.classList.add(classes[score]);
            bar.style.width = widths[score];

            // Optional hints
            const hintTexts = [];
            if (value.length < 8) hintTexts.push("At least 8 characters");
            if (!/[A-Z]/.test(value)) hintTexts.push("Include an uppercase letter");
            if (!/[0-9]/.test(value)) hintTexts.push("Include a number");
            if (!/[^A-Za-z0-9]/.test(value)) hintTexts.push("Include a special character");
            hints.innerText = hintTexts.join(", ");
        }

        pw.addEventListener('input', function() {
            updateBar(this.value);
        });

        updateBar(pw.value || '');
    }

    // --- Password visibility toggle ---
    function togglePassword(buttonId, inputId) {
        const toggleBtn = document.getElementById(buttonId);
        const pwInput = document.getElementById(inputId);
        if (!toggleBtn || !pwInput) return;
        toggleBtn.addEventListener('click', function() {
            if (pwInput.type === 'password') {
                pwInput.type = 'text';
                this.querySelector('i').classList.replace('bi-eye','bi-eye-slash');
            } else {
                pwInput.type = 'password';
                this.querySelector('i').classList.replace('bi-eye-slash','bi-eye');
            }
        });
    }

    togglePassword('togglePassword1', 'id_password1');
    togglePassword('togglePassword2', 'id_password2');

});
</script>
{% endblock %}

<style>
#pw-strength-bar {
    transition: width 250ms ease !important;
    min-width: 2px; /* prevents collapsing when very short */
}
</style>

{% endblock %}
